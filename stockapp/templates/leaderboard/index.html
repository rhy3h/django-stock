{% extends 'base/dashboard.html' %}
{% load static %}
{% load humanize %}

{% block mystyle %}
{% endblock mystyle %}

{% block sidebar %}
<div class="sidebar">
	<!-- Sidebar user (optional) -->
	<div class="user-panel mt-3 pb-3 mb-3 d-flex">
		<div class="image">
			<img src="{% static 'img/wallet.png' %}" alt="" class="brand-image" style="opacity: .8">
		</div>
		<div class="info">
			<a class="d-block">{{ User }}</a>
		</div>
	</div>

	<!-- Sidebar Menu -->
	<nav class="mt-2">
		<ul id="sidebar" class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
		</ul>
	</nav>
	<!-- /.sidebar-menu -->
</div>
<!-- /.sidebar -->

<div class="sidebar-custom">
	<a href="#positive"class="btn btn-secondary hide-on-collapse">買入</a>
	<a href="#negative" class="btn btn-secondary hide-on-collapse pos-right">賣出</a>
</div>
<!-- /.sidebar-custom -->
{% endblock sidebar %}

{% block content %}
<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
	<!-- Content Header (Page header) -->
	<div class="content-header">
		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-12 d-flex justify-content-center flex-wrap flex-md-nowrap align-items-center">
					<h1 class="h2">排行榜
						<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#upload_record">
							上傳
						</button>
						<button type="button" class="btn btn-outline-danger" onclick="download()">
							下載
						</button>
					</h1>
				</div><!-- /.col -->
				
			</div><!-- /.row -->
		</div><!-- /.container-fluid -->
	</div>
	<!-- /.content-header -->

	<div class="content">
		<div class="container-fluid">
			<div class="row">
				<div class="col-lg-12" id="positive">
					<div class="card">
						<div class="card-header text-primary">
							買入排行榜
						</div>
						<div class="card-body">
							<table class="table table-bordered table-striped" id="leader_buyin_table" style="width:100%">
								<thead>
									<tr>
										<th>代碼</th>
										<th>名稱</th>
										<th>差額(仟元)</th>
										<th>主力買超</th>
										<th>出現天數</th>
										<th>外資</th>
										<th>投信</th>
										<th>自營商</th>
									</tr>
								</thead>
								<tbody>
									{% for stock in leader_buyin_list %}
									<tr>
										<td><a href="javascript:SearchWantGoo({{ stock.code }}, '{{ buyin_date.0 }}')">{{ stock.code }}</a></td>
										<td>{{ stock.name }}</td>
										<td>{{ stock.diff|intcomma }}</td>
										<td>{{ stock.days }}</td>
										<td>{{ stock.date|length }}</td>
										<td>{{ stock.sumForeign }}</td>
										<td>{{ stock.sumING }}</td>
										<td>{{ stock.sumDealer }}</td>
									</tr>
									{% endfor %}
								</tbody>
								<tfoot>
									<tr>
										<th>代碼</th>
										<th>名稱</th>
										<th>差額(仟元)</th>
										<th>主力買超</th>
										<th>出現天數</th>
										<th>外資</th>
										<th>投信</th>
										<th>自營商</th>
									</tr>
								</tfoot>
							</table>
						</div>
					</div>		
					<!-- /.card -->
				</div>
				<!-- /.col-md-6 -->
				<div class="col-lg-12" id="negative">
					<div class="card">
						<div class="card-header text-primary">
							賣出排行榜
						</div>
						<div class="card-body">
							<table class="table table-bordered table-striped" id="leader_sellout_table" style="width:100%">
								<thead>
									<tr>
										<th>代碼</th>
										<th>名稱</th>
										<th>差額(仟元)</th>
										<th>主力買超</th>
										<th>出現天數</th>
										<th>外資</th>
										<th>投信</th>
										<th>自營商</th>
									</tr>
								</thead>
								<tbody>
									{% for stock in leader_sellout_list %}
									<tr>
										<td><a href="javascript:SearchWantGoo({{ stock.code }}, '{{ sellout_date.0 }}')">{{ stock.code }}</a></td>
										<td>{{ stock.name }}</td>
										<td>{{ stock.diff|intcomma }}</td>
										<td>{{ stock.days }}</td>
										<td>{{ stock.date|length }}</td>
										<td>{{ stock.sumForeign }}</td>
										<td>{{ stock.sumING }}</td>
										<td>{{ stock.sumDealer }}</td>
									</tr>
									{% endfor %}
								</tbody>
								<tfoot>
									<tr>
										<th>代碼</th>
										<th>名稱</th>
										<th>差額(仟元)</th>
										<th>主力買超</th>
										<th>出現天數</th>
										<th>外資</th>
										<th>投信</th>
										<th>自營商</th>
									</tr>
								</tfoot>
							</table>
						</div>
					</div>		
					<!-- /.card -->
				</div>
				<!-- /.col-md-6 -->
			</div>
			<!-- /.row -->
		</div>
		<!-- /.container-fluid -->
	</div>
</div>
<!-- /.content-wrapper -->
{% endblock content %}

{% block modal %}
<div class="modal fade" id="upload_record" tabindex="-1" aria-labelledby="upload" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">上傳名單</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<p>Csv 格式:</p>
				<p>股票代碼 | 名稱 | 差額(仟元) | 買進 | 賣出 | 外資 | 投信 | 自營商</p>
				<p>p.s. 會自動分辨買入還是賣出</p>
				<form enctype="multipart/form-data" class="needs-validation" method="POST" action="">
				{% csrf_token %}
					<div class="mb-3">
						<div class="mb-3">
							<label for="upload" class="form-label" >上傳檔案</label>
							<input class="form-control" type="file" accept=".csv" id="uploadfiles" name="uploadfiles" multiple>
						</div>
					</div>
					<button type="submit" id="upload_submit" hidden>Continue to checkout</button>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-primary" onclick="document.getElementById('upload_submit').click()">
					上傳
				</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="SearchWantGoo" tabindex="-1" aria-labelledby="SearchWantGoo" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="GoodInfoText">玩股網</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<table id="GoodInfoTable" class="table table-striped">
					<thead>
						<tr>
							<th>日期</th>
							<th>外資</th>
							<th>投信</th>
							<th>自營商</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>
{% endblock modal %}

{% block script %}
<script>
	function download(){
		$("#download-buyin-leaderboard-button").click();
		$("#download-sellout-leaderboard-button").click();
	}

	function SearchWantGoo(stock_id, end_date){
		$.ajax({
			url: '/apis/institutional_investors/' + stock_id + '/' + end_date,
			data: {
			},
			dataType: 'json',
			success: function (data) {
				$("#GoodInfoTable tbody").empty();
				for(let i = 1; i < data.length; i++){
					text =
						"<tr>" + 
						"<th>" + data[i][0] + "</th>" + 
						"<th>" + data[i][1] + "</th>" + 
						"<th>" + data[i][2] + "</th>" + 
						"<th>" + data[i][3] + "</th>" + 
					"</tr>";
					
					$("#GoodInfoTable tbody").append(
						text
					);
				}
				
				$("#GoodInfoTable th").each(function () 
				{
					if( Number($(this).text()) > 0){
						$(this).css("color", "red");
					}
					else if(Number($(this).text()) < 0){
						$(this).css("color", "green");
					}
				});
				$("#GoodInfoText").text(stock_id);
				$('#SearchWantGoo').modal('show');
			}
		});
	}
	
	$(document).ready( function () {
		$("#leader_buyin_table").DataTable({
			"language": {
				"processing": "處理中...",
				"loadingRecords": "載入中...",
				"lengthMenu": "顯示 _MENU_ 項結果",
				"zeroRecords": "沒有符合的結果",
				"info": "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
				"infoEmpty": "顯示第 0 至 0 項結果，共 0 項",
				"infoFiltered": "(從 _MAX_ 項結果中過濾)",
				"infoPostFix": "",
				"search": "搜尋:",
				"paginate": {
					"first": "第一頁",
					"previous": "上一頁",
					"next": "下一頁",
					"last": "最後一頁"
				},
				"aria": {
					"sortAscending": ": 升冪排列",
					"sortDescending": ": 降冪排列"
				}
			},
			"fixedHeader": true,
			"responsive": true,
			"lengthChange": true,
			"autoWidth": false,
			"order": [
				[ 3, 'desc' ],
				[ 2, "desc" ],
			],
			"buttons": [
				{
					extend: 'csv',
					text: '下載CSV',
					attr: {
						id: 'download-buyin-leaderboard-button'
					},
					bom : true,
					title: '{{ buyin_date.0 }} 買入排行榜'
				},
				{
					extend: 'colvis',
					text: '篩選',
				}
			]
		}).buttons().container().appendTo('#leader_buyin_table_wrapper .col-md-6:eq(0)');

		$("#leader_sellout_table").DataTable({
			"language": {
				"processing": "處理中...",
				"loadingRecords": "載入中...",
				"lengthMenu": "顯示 _MENU_ 項結果",
				"zeroRecords": "沒有符合的結果",
				"info": "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
				"infoEmpty": "顯示第 0 至 0 項結果，共 0 項",
				"infoFiltered": "(從 _MAX_ 項結果中過濾)",
				"infoPostFix": "",
				"search": "搜尋:",
				"paginate": {
					"first": "第一頁",
					"previous": "上一頁",
					"next": "下一頁",
					"last": "最後一頁"
				},
				"aria": {
					"sortAscending": ": 升冪排列",
					"sortDescending": ": 降冪排列"
				}
			},
			"fixedHeader": true,
			"responsive": true,
			"lengthChange": true,
			"autoWidth": false,
			"order": [
				[ 3, 'desc' ],
				[ 2, "asc" ]
			],
			"buttons": [
				{
					extend: 'csv',
					text: '下載CSV',
					attr: {
						id: 'download-sellout-leaderboard-button'
					},
					bom : true,
					title: '{{ sellout_date.0 }} 賣出排行榜'
				},
				{
					extend: 'colvis',
					text: '篩選',
				}
			]
		}).buttons().container().appendTo('#leader_sellout_table_wrapper .col-md-6:eq(0)');
	});
</script>
{% endblock script %}