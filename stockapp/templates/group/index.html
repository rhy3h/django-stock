{% extends 'base/dashboard.html' %}
{% load humanize %}

{% block mystyle %}
<style>
	th {
		text-align: center;
		vertical-align: middle;
	}
	a {
		text-decoration:none;
	}
</style>
{% endblock mystyle %}

{% block content %}
{% if group_id %}
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
	<form method="POST" action="" novalidate>
		{% csrf_token %}
		<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
			<h1 class="h2">{{ group.Name }}
				<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#edit_group">
					編輯
				</button>
				<a href="delete" class="btn btn-outline-danger">
					刪除
				</a>
				<a class="btn btn-outline-info" onclick="download_all_table();">
					下載
				</a>
				
				<script>
					function download_all_table(){
						begin_date = document.getElementById("begin_date").value;
						end_date = document.getElementById("end_date").value;
						download_table('positive_table', begin_date, end_date);
						download_table('negative_table', begin_date, end_date);
					}
					function download_table(table_id, begin_date, end_date) {
						if(table_id == 'positive_table')
							table_name = '買入';
						else
							table_name = '賣出';
						let rows = document.querySelectorAll('table#' + table_id +  ' tr');
						let csv = [];
						for (let i = 0; i < rows.length; i++) {
							let row = [], cols = rows[i].querySelectorAll('th');
							for (let j = 0; j < 3; j++) {
								row.push('"' + cols[j].innerText + '"');
							}
							for (let j = 5; j < 8; j++) {
								row.push('"' + cols[j].innerText + '"');
							}
							csv.push(row.join(','));
						}
						let csv_string = csv.join('\n');
						// Download it
						let filename = '{{ group.Name }}' + ' ' + table_name + ' ' + begin_date + ' ' + end_date + '.csv';
						let link = document.createElement('a');
						link.style.display = 'none';
						link.setAttribute('target', '_blank');
						link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent("\uFEFF" + csv_string));
						link.setAttribute('download', filename);
						document.body.appendChild(link);
						link.click();
						document.body.removeChild(link);
					}
				</script>
			</h1>

			<a href="javascript:Crawler_GoodInfo()" class="btn btn-outline-dark">
				同步
			</a>

			<div class="row no-gutters align-items-center">
				<div class="col-sm-5 col-12 mr-2">
					<div class="text-xs font-weight-bold text-primary text-uppercase mb-1">起始日</div>
					<input class="form-control" id="begin_date" name="begin_date" type="date" value="{{ begin_date }}" min="2020-07-07" max="{{ today }}">
				</div>
				<div class="col-sm-5 col-12 mr-2">
					<div class="text-xs font-weight-bold text-primary text-uppercase mb-1">結束日</div>
					<input class="form-control" id="end_date" name="end_date" type="date" value="{{ end_date }}" min="2020-07-07" max="{{ today }}">
				</div>
				<div class="col-sm-2 col-12 mr-2">
					<div class="text-xs font-weight-bold text-primary text-uppercase mb-1">搜尋</div>
					<input class="btn btn-outline-primary" type="submit" value="搜尋" name="search">
				</div>
			</div>
		</div>
	</form>
	<h3 class="h3">券商清單
		<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#add_broker">
			新增
		</button>
		<a class="btn btn-outline-danger" href="clear">
			清除
		</a>
		<a class="btn btn-outline-primary" target="_blank" href="download">
			下載
		</a>
		<a class="btn btn-outline-primary"data-bs-toggle="modal" data-bs-target="#upload">
			上傳
		</a>
	</h3>
	<div id="broker_list" class="row">
		{% for broker in broker_list %}
		<h6 class="fs-4 col-xxl-2 col-xl-3 col-lg-4 col-sm-6 mb-4 d-flex justify-content-between align-items-center">
			<span class="fs-5">{{ broker.Name }}</span>
			<a class="btn btn-outline-danger" href="del-broker/{{ broker.id }}">
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
					<path d="M1.293 1.293a1 1 0 0 1 1.414 0L8 6.586l5.293-5.293a1 1 0 1 1 1.414 1.414L9.414 8l5.293 5.293a1 1 0 0 1-1.414 1.414L8 9.414l-5.293 5.293a1 1 0 0 1-1.414-1.414L6.586 8 1.293 2.707a1 1 0 0 1 0-1.414z"/>
				</svg>
			</a>
		</h6>
		{% endfor %}
	</div>
	<div class="row">
		<div class="col-12 mb-4" id="positive">
			<div class="card">
				<div class="card-header text-primary">
					買入
				</div>
				<div class="card-body">
					<table class="table table-bordered" id="positive_table">
						<thead>
							<tr>
								<th>股票代碼</th>
								<th>名稱</th>
								<th>差額(仟元)</th>
								<th>買進</th>
								<th>賣出</th>
								<th>外資</th>
								<th>投信</th>
								<th>自營商</th>
							</tr>
						</thead>
						<tbody>
							{% for stock in stock_list.positive %}
							<tr>
								<th><a href="javascript:SearchWantGoo({{ stock.id }})">{{ stock.id }}</a></th>
								<th>{{ stock.name }}</th>
								<th>{{ stock.diff|intcomma }}</th>
								<th>
								{% for buy in stock.buy_in %}
								{{ buy }}<br>
								{% endfor %}
								</th>
								<th>
								{% for sell in stock.sell_out %}
								{{ sell }}<br>
								{% endfor %}
								</th>
								<th>{{ stock.sumForeign }}</th>
								<th>{{ stock.sumING }}</th>
								<th>{{ stock.sumDealer }}</th>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<div class="col-12 mb-4" id="negative">
			<div class="card">
				<div class="card-header text-primary">
					  賣出
				</div>
				<div class="card-body">
					<table class="table table-bordered" id="negative_table">
						<thead>
							<tr>
								<th>股票代碼</th>
								<th>名稱</th>
								<th>差額(仟元)</th>
								<th>買進</th>
								<th>賣出</th>
								<th>外資</th>
								<th>投信</th>
								<th>自營商</th>
							</tr>
						</thead>
						<tbody>
							{% for stock in stock_list.negative %}
							<tr>
								<th><a href="javascript:SearchWantGoo({{ stock.id }})">{{ stock.id }}</a></th>
								<th>{{ stock.name }}</th>
								<th>{{ stock.diff|intcomma }}</th>
								<th>
								{% for buy in stock.buy_in %}
								{{ buy }}<br>
								{% endfor %}
								</th>
								<th>
								{% for sell in stock.sell_out %}
								{{ sell }}<br>
								{% endfor %}
								</th>
								<th>{{ stock.sumForeign }}</th>
								<th>{{ stock.sumING }}</th>
								<th>{{ stock.sumDealer }}</th>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</main>
{% endif %}
{% endblock content %}


{% block modal %}
<div class="modal fade" id="new_group" tabindex="-1" aria-labelledby="new_group" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">新增群組</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form class="needs-validation" method="POST" action="/group/create/" novalidate>
				{% csrf_token %}
					<div class="form-floating mb-3">
						<input type="text" class="form-control" id="group_name" name="group_name" placeholder="群組名稱" required>
						<label for="group_name">群組名稱</label>
					</div>
					<button class="" type="submit" id="add_group_submit" hidden>Continue to checkout</button>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-primary" onclick="document.getElementById('add_group_submit').click()">新增</button>
			</div>
		</div>
	</div>
</div>
<div class="modal fade" id="edit_group" tabindex="-1" aria-labelledby="edit_group" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">編輯群組</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form class="needs-validation" method="POST" action="edit" novalidate>
				{% csrf_token %}
					<div class="form-floating mb-3">
						<input type="text" class="form-control" id="new_group_name" name="new_group_name" value="{{ group.Name }}" placeholder="新名稱" required>
						<label for="new_group_name">新名稱</label>
					</div>
					<button class="" type="submit" id="edit_group_submit" hidden>Continue to checkout</button>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-primary" onclick="document.getElementById('edit_group_submit').click()">
					確認
				</button>
			</div>
		</div>
	</div>
</div>
<div class="modal fade" id="upload" tabindex="-1" aria-labelledby="upload" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">上傳券商</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form enctype="multipart/form-data"  class="needs-validation" method="POST" action="upload" novalidate>
				{% csrf_token %}
					<div class="form-floating mb-3">
						<div class="mb-3">
							<label for="upload" class="form-label" >上傳檔案</label>
							<input class="form-control" type="file" accept=".csv" id="uploadfile" name="uploadfile">
						  </div>
					</div>
					<button type="submit" id="upload_submit" hidden>Continue to checkout</button>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-primary" onclick="document.getElementById('upload_submit').click()">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
						<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
						<path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
					</svg>
				</button>
			</div>
		</div>
	</div>
</div>
<div class="modal fade" id="add_broker" tabindex="-1" aria-labelledby="add_broker" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">新增券商</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form class="needs-validation" method="POST" action="add-broker/" id="add_broker_form" novalidate>
				{% csrf_token %}
					<div class="row">
						<div class="col-sm-6">
							<div class="input-group mb-3">
								<input id="input_broker" type="text" class="form-control" placeholder="券商" aria-label="Stock" aria-describedby="basic-addon1">
							</div>
						</div>
						<div class="col-sm-6">
							<div class="input-group mb-3">
								<input id="input_branch" type="text" class="form-control" placeholder="分部" aria-label="Stock" aria-describedby="basic-addon1">
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-6">
							<select class="form-select mb-3" id="select_broker" name="select_broker" onchange="generate_branch_list()">
								<script>
									generate_broker_list();
								</script>
							</select>
						</div>
						<div class="col-sm-6">
							<select class="form-select mb-3" id="select_branch" name="select_branch">
								<script>
									generate_branch_list();
								</script>
							</select>
						</div>
					</div>
					<button class="" type="submit" id="add_broker_submit" hidden>Continue to checkout</button>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-primary" onclick="document.getElementById('add_broker_submit').click()">
					確認
				</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="SearchWantGoo" tabindex="-1" aria-labelledby="SearchWantGoo" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="GoodInfoText">玩股網</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<table id="GoodInfoTable" class="table table-striped">
					<thead>
						<tr>
							<th>日期</th>
							<th>外資</th>
							<th>投信</th>
							<th>自營商</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="Crawler_Modal" tabindex="-1" aria-labelledby="Crawler_Modal" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header h1 d-flex justify-content-center">
				爬蟲進行中
			</div>
			<div class="modal-body h5 d-flex justify-content-center">
				<div class="spinner-border" role="status">
					<span class="visually-hidden">Loading...</span>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock modal %}

{% block script %}
<script>
	$('#input_broker').on('keydown',function(e){
		if(e.keyCode == 13) {
			input_broker_text = document.getElementById('input_broker').value
			if(input_broker_text.length > 0){
				select_broker = document.getElementById("select_broker");
				
				for (i = 0; i < select_broker.length; i++) {
					if(select_broker.options[i].text.search(input_broker_text) >= 0){
						document.getElementById("select_broker").selectedIndex = i;
						generate_branch_list();
						break;
					}
				}
			}
			event.preventhefault();
			return false;
		}
	});
	$('#input_branch').on('keydown',function(e){
		if(e.keyCode == 13) {
			input_branch_text = document.getElementById('input_branch').value
			if(input_branch_text.length > 0){
				select_branch = document.getElementById("select_branch");
				
				for (i = 0; i < select_branch.length; i++) {
					if(select_branch.options[i].text.search(input_branch_text) >= 0){
						document.getElementById("select_branch").selectedIndex = i;
						break;
					}
				}
			}
			event.preventhefault();
			return false;
		}
	});
	$("#positive_table th").each(function () 
	{
		if( Number($(this).text()) > 0){
			$(this).css("color", "red");
		}
		else if(Number($(this).text()) < 0){
			$(this).css("color", "green");
		}
	});
	$("#negative_table th").each(function () 
	{
		if( Number($(this).text()) > 0){
			$(this).css("color", "red");
		}
		else if(Number($(this).text()) < 0){
			$(this).css("color", "green");
		}
	});
	function SearchWantGoo(stock_id){
		let end_date = $("#end_date").val();
		$.ajax({
			url: '/apis/institutional_investors/' + stock_id + '/' + end_date,
			data: {
			},
			dataType: 'json',
			success: function (data) {
				$("#GoodInfoTable tbody").empty();
				
				for(let i = 1; i < data.length; i++){
					text =
						"<tr>" + 
						"<th>" + data[i][0] + "</th>" + 
						"<th>" + data[i][1] + "</th>" + 
						"<th>" + data[i][2] + "</th>" + 
						"<th>" + data[i][3] + "</th>" + 
					"</tr>";
					
					$("#GoodInfoTable tbody").append(
						text
					);
				}
				
				$("#GoodInfoTable th").each(function () 
				{
					if( Number($(this).text()) > 0){
						$(this).css("color", "red");
					}
					else if(Number($(this).text()) < 0){
						$(this).css("color", "green");
					}
				});
				$("#GoodInfoText").text(stock_id)
				$('#SearchWantGoo').modal('show')
			}
		});
	}
	function Crawler_GoodInfo(){
		$("#Crawler_Modal").modal('show');

		$.ajax({
			url: 'sync/',
			data: {
			},
			dataType: 'json',
			success: function (data) {
				$("#Crawler_Modal .modal-header").text("爬蟲完畢");
				$("#Crawler_Modal .modal-body").empty();
				$("#Crawler_Modal .modal-body").text("三秒後重整");
				setTimeout(function(){ location.reload() }, 3000);
			}
		});
	}
</script>
{% endblock script %}