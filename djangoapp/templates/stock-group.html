{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block mystyle %}
<style>
	/*the container must be positioned relative:*/
	.autocomplete {
		position: relative;
		display: inline-block;
	}
	.autocomplete-items {
		position: absolute;
		border: 0px solid #d4d4d4;
		border-bottom: none;
		border-top: none;
		z-index: 99;
		/*position the autocomplete items to be the same width as the container:*/
		top: 100%;
		left: 50%;
		right: 0;
		width: 100%;
		margin: 5px 0 0 -249px;
	}
	.autocomplete-items div {
		padding: 10px;
		cursor: pointer;
		background-color: #fff; 
		border-bottom: 1px solid #d4d4d4; 
	}
	/*when hovering an item:*/
	.autocomplete-items div:hover {
		background-color: #e9e9e9; 
	}
	/*when navigating through the items using the arrow keys:*/
	.autocomplete-active {
		background-color: DodgerBlue !important; 
		color: #ffffff; 
	}
</style>
{% endblock mystyle %}

{% block sidebar %}
<div class="sidebar">
	<!-- Sidebar user (optional) -->
	<div class="user-panel mt-3 pb-3 mb-3 d-flex">
		<div class="image">
			<img src="{% static 'img/wallet.png' %}" alt="" class="brand-image" style="opacity: .8">
		</div>
		<div class="info">
			<a class="d-block">{{ User }}</a>
		</div>
	</div>

	<!-- Sidebar Menu -->
	<nav class="mt-2">
		<ul id="sidebar" class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
			<li class="nav-item">
				<a href="#new-group" class="nav-link" data-bs-toggle="modal" data-bs-target="#new-stock-group">
					<i class="far fa-circle nav-icon"></i>
					<p>新增股票群組</p>
				</a>
			</li>
			{% for group in stock_group_list %}
			<li class="nav-item">
				<a href="/stock-group/{{ group.id }}/?index=0" class="nav-link">
				<i class="far fa-circle nav-icon"></i>
				<p>{{ group.Name }}</p>
				</a>
			</li>
			{% endfor %}
		</ul>
	</nav>
	<!-- /.sidebar-menu -->
</div>
{% endblock sidebar %}

<!-- /.sidebar -->
{% block content %}
<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
	{% if stock_group %}
	<!-- Content Header (Page header) -->
	<div class="content-header">
		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-4 d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center">
					<h1 class="m-0">{{ stock_group.Name }}
						<a class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#edit-stock-group">
							編輯
						</a>
						<a class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#delete-stock-group">
							刪除
						</a>
					</h1>
				</div><!-- /.col -->

				<div class="col-sm-4 d-flex justify-content-center flex-wrap flex-md-nowrap align-items-center">
				
				</div><!-- /.col -->
				
				<div class="col-sm-4 d-flex justify-content-end flex-wrap flex-md-nowrap align-items-center">
					
				</div><!-- /.col -->
			</div><!-- /.row -->
			<h3 class="h3 pt-3">股票清單
				<a class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#upload">
				上傳
				</a>
			</h3>
			<div id="stock-list" class="row border-bottom">
				{% for item in stock_group_item_list %}
					{% if item.Code == code %}
					<h6 class="fs-4 col-xxl-2 col-xl-4 col-lg-4 col-sm-6 d-flex justify-content-center align-items-center text-primary">
						<span class="fs-5">{{ item.Name }}</span>
					</h6>
					{% else %}
					<h6 class="fs-4 col-xxl-2 col-xl-4 col-lg-4 col-sm-6 d-flex justify-content-center align-items-center">
						<span class="fs-5">{{ item.Name }}</span>
					</h6>
					{% endif %}
				{% endfor %}
			</div>
		</div><!-- /.container-fluid -->
	</div>
	<!-- /.content-header -->
	{% endif %}
	<div class="content">
		<div class="container-fluid">
			<div class="row pt-3 ">
				<div class="col-lg-12">
					<div class="card">
						{{div | safe}}
					</div>		
					<!-- /.card -->
				</div>
				<!-- /.col-md-6 -->
			</div>
			<!-- /.row -->
		</div>
		<!-- /.container-fluid -->
	</div>
</div>
<!-- /.content-wrapper -->
{% endblock content %}

{% block modal %}
<div class="modal fade" id="new-stock-group" tabindex="-1" aria-labelledby="new-stock-group" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">新增股票群組</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form class="needs-validation" method="POST" action="/stock-group/create/">
				{% csrf_token %}
					<div class="mb-3">
						<label for="group-name">群組名稱</label>
						<input type="text" class="form-control" id="stock-group-name" name="stock-group-name" placeholder="群組名稱" autocomplete="off" required>
					</div>
					<button type="submit" id="new-stock-group-submit" hidden>Continue to checkout</button>
				</form>
			</div>
			<div class="modal-footer">
				<button type="submit" class="btn btn-outline-primary" onclick="document.getElementById('new-stock-group-submit').click()">
					確認
				</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="delete-stock-group" tabindex="-1" aria-labelledby="delete-stock-group" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">刪除股票群組</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				確認刪除 <font class="text-danger">{{ stock_group.Name }}</font> 股票群組？
			</div>
			<div class="modal-footer">
				<form class="needs-validation" method="POST" action="delete">
					{% csrf_token %}
					<button class="btn btn-outline-danger" type="submit" id="new-broker-group-submit">刪除</button>
				</form>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="delete-stock" tabindex="-1" aria-labelledby="delete-stock-group" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">刪除股票</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				確認刪除股票 <font class="text-danger"></font> ？
			</div>
			<div class="modal-footer">
				<form class="needs-validation" method="POST" action="delete">
					{% csrf_token %}
					<button class="btn btn-outline-danger" type="submit" id="new-broker-group-submit">刪除</button>
				</form>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="edit-stock-group" tabindex="-1" aria-labelledby="edit-stock-group" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">編輯群組</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form class="needs-validation" method="POST" action="edit">
					{% csrf_token %}
					<div class="mb-3">
						<label for="new-group-name">新名稱</label>
						<input type="text" class="form-control" id="new-group-name" name="new-group-name" value="{{ stock_group.Name }}" placeholder="新名稱" autocomplete="off" required>
					</div>
					<button type="submit" id="edit-stock-group-submit" hidden>Continue to checkout</button>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-primary" onclick="document.getElementById('edit-stock-group-submit').click()">
					確認
				</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="upload" tabindex="-1" aria-labelledby="upload" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">上傳券商清單</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<p>Excel 格式:</p>
				<p>代號 | 名稱</p>
				<p>p.s. 自動將舊的股票全都刪除</p>
				<form enctype="multipart/form-data"  class="needs-validation" method="POST" action="upload">
				{% csrf_token %}
				<div class="form-floating mb-3">
					<div class="mb-3">
					<label for="upload" class="form-label" >上傳檔案</label>
					<input class="form-control" type="file" accept=".xlsx" id="uploadfile" name="uploadfile" required>
					</div>
				</div>
				<button type="submit" id="upload-submit" hidden>Continue to checkout</button>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-primary" onclick="document.getElementById('upload-submit').click()">
				上傳
				</button>
			</div>
		</div>
	</div>
</div>
{% endblock modal %}

{% block script %}
<script src="https://cdn.bokeh.org/bokeh/release/bokeh-2.3.2.min.js"></script>
<script src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.3.2.min.js"></script>
<script src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.3.2.min.js"></script>
<script src="https://cdn.bokeh.org/bokeh/release/bokeh-api-2.3.2.min.js"></script>
{{script | safe}}
<script>
	$('#add-stock-modal').on('hidden.bs.modal', function () {
		$(this).find('form').trigger('reset');
	})
	function sync_end_date(){
		document.getElementById("end-date").value = document.getElementById("begin-date").value;
	}
	
	$('#sidebar').find('a').each(function () {
		if (this.href == document.location.href || document.location.href.search(this.href) >= 0) {
			$(this).addClass('active');
		}
	});
	document.onkeyup = checkKey;

	function checkKey(e) {

		e = e || window.event;

		if (e.keyCode == '37') { // left arrow
			let url = window.location.href;
			let para = url.split("/");
			let index = para[para.length - 1].split("=");
			let new_index = parseInt(index[index.length - 1]) - 1;
			if(new_index >= 0) {
				window.location.replace('/stock-group/{{ stock_group.id }}/?index=' + new_index);
			}
		}
		if (e.keyCode == '39') { // right arrow
			let url = window.location.href;
			let para = url.split("/");
			let index = para[para.length - 1].split("=");
			let new_index = parseInt(index[index.length - 1]) + 1;
			
			if(new_index < {{ max_length }}) {
				window.location.replace('/stock-group/{{ stock_group.id }}/?index=' + new_index);
			}
		}
	}
</script>
{% endblock script %}